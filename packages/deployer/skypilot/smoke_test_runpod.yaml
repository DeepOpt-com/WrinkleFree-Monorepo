# RunPod Smoke Test - Quick validation with GPU
#
# Launch:
#   source credentials/.env
#   export SKYPILOT_DOCKER_PASSWORD=$(cat credentials/gcp-service-account.json | base64 -w0)
#   sky launch skypilot/smoke_test_runpod.yaml -y --secret WANDB_API_KEY --secret SKYPILOT_DOCKER_PASSWORD
#
# Monitor:
#   sky logs <cluster_name>
#
# Down:
#   sky down <cluster_name> -y

name: wf-smoke-runpod

resources:
  # Docker image from Google Artifact Registry (GAR)
  image_id: docker:us-docker.pkg.dev/wrinklefree-481904/wf-train/wf-train:latest
  cloud: runpod
  accelerators: H100:1
  use_spot: false
  disk_size: 100
  disk_tier: best

# Sync training code (monorepo paths)
workdir: ../training

# Mount GCS credentials + CheaperTraining for influence
file_mounts:
  /gcs-creds/gcp-service-account.json: credentials/gcp-service-account.json
  /cheapertraining: ../cheapertraining

envs:
  # Model config
  MODEL: smollm2_135m

  # W&B tracking
  WANDB_PROJECT: wrinklefree

  # GCS credentials (mounted file)
  GOOGLE_APPLICATION_CREDENTIALS: /gcs-creds/gcp-service-account.json

  # Docker registry auth - RunPod requires BASE64 encoded credentials
  SKYPILOT_DOCKER_USERNAME: _json_key_base64
  SKYPILOT_DOCKER_SERVER: us-docker.pkg.dev

# Secrets are passed via --secret flag and redacted from logs/dashboard
secrets:
  WANDB_API_KEY: null
  SKYPILOT_DOCKER_PASSWORD: null  # Base64-encoded GCP service account JSON

setup: |
  set -e
  cd ~/sky_workdir

  # Base dependencies are pre-installed in the Docker image
  source /app/.venv/bin/activate

  # Install wrinklefree package (editable)
  pip install -e . --no-deps

  # Install CheaperTraining for influence-based training
  pip install -e /cheapertraining --no-deps

  # Verify GPU setup
  python -c "import torch; print(f'GPUs: {torch.cuda.device_count()}'); [print(f'  {i}: {torch.cuda.get_device_name(i)}') for i in range(torch.cuda.device_count())]"

  # Verify GCS credentials
  echo "Testing GCS access..."
  python -c "from google.cloud import storage; client = storage.Client(); bucket = client.bucket('wrinklefree-checkpoints'); print(f'GCS bucket access: {bucket.exists()}')"

run: |
  set -e
  cd ~/sky_workdir
  source /app/.venv/bin/activate

  echo "=============================================="
  echo "WrinkleFree Smoke Test - RunPod 1x H100"
  echo "Model: ${MODEL}"
  echo "W&B Project: ${WANDB_PROJECT}"
  echo "=============================================="

  # Single GPU settings
  COMMON_ARGS="distributed=single_gpu gcs.enabled=true gcs.bucket=wrinklefree-checkpoints"

  # Stage 1.9: Layer-wise distillation (quick, ~100 steps for smoke test)
  echo ""
  echo "=== Stage 1.9: Layer-wise Distillation ==="
  python scripts/train.py \
    model=${MODEL} \
    training=stage1_9_layerwise \
    training.max_steps=100 \
    training.batch_size=8 \
    training.gradient_accumulation_steps=1 \
    training.max_seq_length=512 \
    training.logging.log_interval=10 \
    ${COMMON_ARGS}

  echo "Stage 1.9 complete!"

  # Stage 2: Continue pre-training (quick, ~100 steps for smoke test)
  echo ""
  echo "=== Stage 2: Continue Pre-Training ==="
  python scripts/train.py \
    model=${MODEL} \
    training=stage2_pretrain \
    training.max_steps=100 \
    training.batch_size=8 \
    training.gradient_accumulation_steps=1 \
    training.max_seq_length=512 \
    training.logging.log_interval=10 \
    ${COMMON_ARGS}

  echo "Stage 2 complete!"

  echo ""
  echo "=============================================="
  echo "SMOKE TEST COMPLETE!"
  echo "Check W&B: https://wandb.ai/${WANDB_ENTITY:-your-entity}/${WANDB_PROJECT}"
  echo "Check GCS: gs://wrinklefree-checkpoints/"
  echo "=============================================="
