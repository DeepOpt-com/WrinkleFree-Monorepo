# LRC Full Run - Qwen3-0.6B on Nebius H100
#
# Full LRC (Low-Rank Correction) + DLM training run:
# - Model: Qwen3-0.6B (auto-converted to BitNet)
# - LRC rank: 25% (better error recovery than 10% calibration)
# - Objectives: CE (weight=1.0) + DLM (weight=0.5)
# - Total tokens: 1B
# - Auto batch size: finds optimal batch for H100
#
# Launch:
#   cd packages/deployer
#   source credentials/.env
#   sky launch skypilot/lrc_run.yaml -y --cluster lrc-run
#
# Monitor:
#   sky logs lrc-run
#
# Down:
#   sky down lrc-run -y

name: wf-lrc-run

resources:
  accelerators: H100:1
  memory: 64+
  use_spot: false
  cloud: nebius
  disk_size: 100

# Sync entire monorepo
workdir: /home/lev/code/WrinkleFreeWORKTREE/InfluenceClean

file_mounts:
  /tmp/gcp-creds.json: /home/lev/code/WrinkleFree/WrinkleFree-Deployer/credentials/gcp-service-account.json
  /tmp/credentials.env: /home/lev/code/WrinkleFree/WrinkleFree-Deployer/credentials/.env
  /tmp/global.env: ~/.config/.env.global

envs:
  GOOGLE_APPLICATION_CREDENTIALS: /tmp/gcp-creds.json
  GCS_BUCKET: wrinklefree-checkpoints
  MODEL: qwen3_0.6b
  WANDB_PROJECT: wrinklefree_v2
  HF_HUB_ENABLE_HF_TRANSFER: "1"

setup: |
  set -e
  cd ~/sky_workdir

  if ! command -v uv &> /dev/null; then
    curl -LsSf https://astral.sh/uv/install.sh | sh
    export PATH="$HOME/.cargo/bin:$PATH"
  fi

  # Install gcloud SDK for GCS uploads
  if ! command -v gcloud &> /dev/null; then
    echo "Installing Google Cloud SDK..."
    rm -rf $HOME/google-cloud-sdk
    curl -sSL https://sdk.cloud.google.com | bash -s -- --disable-prompts --install-dir=$HOME
    export PATH="$HOME/google-cloud-sdk/bin:$PATH"
  fi

  # Configure gcloud with service account
  if [ -f /tmp/gcp-creds.json ]; then
    echo "Activating GCP service account..."
    gcloud auth activate-service-account --key-file=/tmp/gcp-creds.json
    gcloud config set project wrinklefree-481904
  fi

  uv sync --all-packages

  # Verify imports
  echo "Verifying LRC imports..."
  uv run python -c "from wf_arch import BitLinearLRC, convert_bitlinear_to_lrc; print('LRC imports OK!')"

  echo "Setup complete!"

run: |
  set -e
  cd ~/sky_workdir
  export PATH="$HOME/.cargo/bin:$HOME/google-cloud-sdk/bin:$PATH"

  set -a
  source /tmp/credentials.env
  source /tmp/global.env
  set +a
  export HF_TOKEN="${HUGGINGFACE_WRITE_TOKEN}"

  echo "WANDB_API_KEY is set: $([ -n \"$WANDB_API_KEY\" ] && echo 'yes' || echo 'no')"

  CHECKPOINT_DIR="/tmp/checkpoints"
  mkdir -p $CHECKPOINT_DIR

  echo "=============================================="
  echo "LRC Full Run - Qwen3-0.6B on H100"
  echo "=============================================="
  echo "Model: ${MODEL}"
  echo "Training: lrc_run (LRC 25% + CE + DLM)"
  echo "Total tokens: 1B"
  echo "Auto batch size: enabled"
  echo ""
  echo "Objectives:"
  echo "  - CE (continue_pretrain): weight=1.0"
  echo "  - DLM: weight=0.5, mask_prob=0.15"
  echo ""
  echo "Logging:"
  echo "  - WandB: ${WANDB_PROJECT}"
  echo "  - GCS: gs://${GCS_BUCKET}/"
  echo "=============================================="

  uv run --package wf-train python packages/training/scripts/train_lightning.py \
    model=${MODEL} \
    training=lrc_run \
    data.config_name=mixed_pretrain \
    distributed=single_gpu \
    output_dir=$CHECKPOINT_DIR \
    experiment_name=lrc_run_qwen3_0.6b \
    \
    training.auto_batch_size=true \
    \
    training.checkpoint.save_interval=500 \
    training.logging.log_interval=10 \
    training.logging.wandb.enabled=true \
    training.logging.wandb.project=${WANDB_PROJECT} \
    training.logging.wandb.name=lrc-run-qwen3-0.6b-h100 \
    training.logging.wandb.tags="[lrc,dlm,25pct-rank,h100,qwen3-0.6b]" \
    gcs.enabled=true \
    gcs.bucket=${GCS_BUCKET}

  echo ""
  echo "=============================================="
  echo "LRC Run Training Complete!"
  echo "=============================================="
  echo ""
  echo "Checkpoints:"
  ls -la $CHECKPOINT_DIR/lrc_run_qwen3_0.6b/checkpoints/ 2>/dev/null || echo "No local checkpoints"
  echo ""
  echo "GCS checkpoints:"
  gcloud storage ls "gs://${GCS_BUCKET}/experiments/" 2>/dev/null | grep lrc | head -10 || echo "GCS listing failed"
  echo ""
  echo "WandB: https://wandb.ai/${WANDB_PROJECT}"
