# Stage 3 Checkpoint Handoff Test
# Verifies Stage 3 loads Stage 2 checkpoint from GCS
#
# Launch:
#   cd WrinkleFree-Deployer
#   source credentials/.env
#   sky jobs launch skypilot/stage3_handoff_test.yaml -y --env WANDB_API_KEY

name: wrinklefree-stage3-test

resources:
  cloud: nebius
  accelerators: H100:1
  use_spot: false
  disk_size: 100
  disk_tier: best

workdir: ../WrinkleFree-1.58Quant

file_mounts:
  /gcs-creds/gcp-service-account.json: credentials/gcp-service-account.json
  # Mount at path relative to workdir that pyproject.toml expects
  ~/WrinkleFree-CheaperTraining: ../WrinkleFree-CheaperTraining

envs:
  MODEL: smollm2_135m
  EXPERIMENT_NAME: bitdistill_smollm2_135m
  WANDB_PROJECT: wrinklefree
  GOOGLE_APPLICATION_CREDENTIALS: /gcs-creds/gcp-service-account.json

setup: |
  set -e
  cd ~/sky_workdir

  if ! command -v uv &> /dev/null; then
    curl -LsSf https://astral.sh/uv/install.sh | sh
    source $HOME/.local/bin/env
  fi

  uv sync

  # Install CheaperTraining (mounted at expected path)
  uv pip install -e ~/WrinkleFree-CheaperTraining

  uv run python -c "import torch; print(f'GPU: {torch.cuda.get_device_name(0)}')"
  uv run python -c "from google.cloud import storage; client = storage.Client(); print('GCS: OK')"

run: |
  set -e
  cd ~/sky_workdir
  source $HOME/.local/bin/env

  echo "=============================================="
  echo "Stage 3 Checkpoint Handoff Test"
  echo "Experiment: ${EXPERIMENT_NAME}"
  echo "=============================================="

  echo "Checking for Stage 2 checkpoint..."
  gsutil ls -l gs://wrinklefree-checkpoints/checkpoints/${EXPERIMENT_NAME}/stage2_checkpoint/ || echo "No Stage 2 checkpoint found"

  echo ""
  echo "=== Stage 3: Distillation (loading Stage 2 checkpoint) ==="
  uv run python scripts/train.py \
    model=${MODEL} \
    training=stage3_distill_smollm2 \
    training.max_steps=100 \
    training.batch_size=8 \
    training.gradient_accumulation_steps=16 \
    training.max_seq_length=512 \
    training.logging.log_interval=5 \
    experiment_name=${EXPERIMENT_NAME} \
    distributed=single_gpu \
    gcs.enabled=true \
    gcs.bucket=wrinklefree-checkpoints

  echo ""
  echo "=============================================="
  echo "Stage 3 COMPLETE!"
  echo "=============================================="

  echo "Checking Stage 3 checkpoint in GCS..."
  gsutil ls -l gs://wrinklefree-checkpoints/checkpoints/${EXPERIMENT_NAME}/stage3_checkpoint/ || echo "No Stage 3 checkpoint found"
