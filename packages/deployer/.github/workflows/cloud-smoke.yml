name: Cloud Smoke Tests

on:
  schedule:
    # Run weekly on Sunday at 2 AM UTC
    - cron: '0 2 * * 0'
  workflow_dispatch:
    inputs:
      cloud:
        description: 'Cloud provider to test'
        required: true
        default: 'both'
        type: choice
        options:
          - aws
          - gcp
          - both

env:
  TERRAFORM_VERSION: '1.6.6'
  PYTHON_VERSION: '3.12'

jobs:
  # ==========================================================================
  # AWS Cloud Smoke Tests
  # ==========================================================================
  cloud-smoke-aws:
    name: AWS Smoke Test
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.cloud == 'aws' || github.event.inputs.cloud == 'both' || github.event_name == 'schedule' }}
    environment: cloud-smoke-tests
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Install dependencies
        run: uv sync --dev

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Install SkyPilot
        run: |
          uv pip install "skypilot[aws]"
          sky check aws

      - name: Run AWS cloud smoke tests
        if: ${{ hashFiles('tests/test_cloud_smoke.py') != '' }}
        env:
          CLOUD_SMOKE_RESULTS: aws-smoke-results.json
        run: |
          uv run pytest tests/test_cloud_smoke.py \
            --cloud aws \
            -m cloud \
            --json-report \
            --json-report-file=aws-results.json \
            -v
        continue-on-error: true

      - name: Cleanup any resources
        if: always()
        run: |
          sky down --all -y || true
          sky status || true

      - name: Upload Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: aws-smoke-results
          path: |
            aws-results.json
            aws-smoke-results.json

  # ==========================================================================
  # GCP Cloud Smoke Tests
  # ==========================================================================
  cloud-smoke-gcp:
    name: GCP Smoke Test
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.cloud == 'gcp' || github.event.inputs.cloud == 'both' || github.event_name == 'schedule' }}
    environment: cloud-smoke-tests
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Install dependencies
        run: uv sync --dev

      - name: Configure GCP credentials
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Install SkyPilot
        run: |
          uv pip install "skypilot[gcp]"
          sky check gcp

      - name: Run GCP cloud smoke tests
        if: ${{ hashFiles('tests/test_cloud_smoke.py') != '' }}
        env:
          CLOUD_SMOKE_RESULTS: gcp-smoke-results.json
        run: |
          uv run pytest tests/test_cloud_smoke.py \
            --cloud gcp \
            -m cloud \
            --json-report \
            --json-report-file=gcp-results.json \
            -v
        continue-on-error: true

      - name: Cleanup any resources
        if: always()
        run: |
          sky down --all -y || true
          sky status || true

      - name: Upload Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: gcp-smoke-results
          path: |
            gcp-results.json
            gcp-smoke-results.json

  # ==========================================================================
  # Notify on Failure
  # ==========================================================================
  notify:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [cloud-smoke-aws, cloud-smoke-gcp]
    if: failure()
    steps:
      - name: Create failure summary
        run: |
          echo "## Cloud Smoke Tests Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "One or more cloud smoke tests failed. Check the workflow run for details." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- AWS: ${{ needs.cloud-smoke-aws.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- GCP: ${{ needs.cloud-smoke-gcp.result }}" >> $GITHUB_STEP_SUMMARY
