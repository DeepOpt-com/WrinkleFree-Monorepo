name: Infrastructure Tests

on:
  push:
    branches: [main, develop]
    paths:
      - 'terraform/**'
      - 'tests/**'
      - 'docker/**'
      - '.github/workflows/infra-test.yml'
  pull_request:
    branches: [main]
    paths:
      - 'terraform/**'
      - 'tests/**'
      - 'docker/**'
      - '.github/workflows/infra-test.yml'
  workflow_dispatch:

env:
  TERRAFORM_VERSION: '1.6.6'
  TFLINT_VERSION: '0.50.0'
  PYTHON_VERSION: '3.12'

jobs:
  # ==========================================================================
  # Stage 1: Static Analysis (fastest)
  # ==========================================================================
  static-analysis:
    name: Static Analysis
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Format Check
        run: terraform fmt -check -recursive terraform/

      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@v4
        with:
          tflint_version: ${{ env.TFLINT_VERSION }}

      - name: Initialize TFLint
        run: tflint --init
        working-directory: terraform/

      - name: Run TFLint (Hetzner)
        run: tflint --config ../.tflint.hcl
        working-directory: terraform/hetzner/
        continue-on-error: false

      - name: Run TFLint (GCP)
        run: tflint --config ../.tflint.hcl
        working-directory: terraform/gcp/
        continue-on-error: false

      - name: Run TFLint (AWS)
        run: tflint --config ../.tflint.hcl
        working-directory: terraform/aws/
        continue-on-error: false

  # ==========================================================================
  # Stage 2: Security Scanning
  # ==========================================================================
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: static-analysis
    steps:
      - uses: actions/checkout@v4

      - name: Run Checkov
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: terraform/
          framework: terraform
          config_file: .checkov.yaml
          output_format: cli,sarif
          output_file_path: console,results.sarif
          soft_fail: false

      - name: Upload SARIF results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: results.sarif

  # ==========================================================================
  # Stage 3: Terraform Validation
  # ==========================================================================
  terraform-validate:
    name: Terraform Validate
    runs-on: ubuntu-latest
    needs: static-analysis
    strategy:
      matrix:
        module: [hetzner, gcp, aws]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Init
        run: terraform init -backend=false
        working-directory: terraform/${{ matrix.module }}/

      - name: Terraform Validate
        run: terraform validate
        working-directory: terraform/${{ matrix.module }}/

  # ==========================================================================
  # Stage 4: Terraform Native Tests
  # ==========================================================================
  terraform-tests:
    name: Terraform Tests
    runs-on: ubuntu-latest
    needs: terraform-validate
    strategy:
      matrix:
        module: [hetzner, gcp, aws]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Setup Test Fixtures (Hetzner)
        if: matrix.module == 'hetzner'
        run: |
          cd terraform/hetzner/tests/setup
          terraform init
          terraform apply -auto-approve
        continue-on-error: true

      - name: Terraform Init
        run: terraform init -backend=false
        working-directory: terraform/${{ matrix.module }}/

      - name: Terraform Test
        run: terraform test -verbose
        working-directory: terraform/${{ matrix.module }}/
        continue-on-error: false

  # ==========================================================================
  # Stage 5: Integration Tests with LocalStack
  # ==========================================================================
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: terraform-validate
    services:
      localstack:
        image: localstack/localstack:3.0
        ports:
          - 4566:4566
        env:
          SERVICES: ec2,s3,iam,sts
          DEFAULT_REGION: us-east-1
        options: >-
          --health-cmd "curl -f http://localhost:4566/_localstack/health"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10

      fake-gcs:
        image: fsouza/fake-gcs-server:1.47
        ports:
          - 4443:4443

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Install dependencies
        run: uv sync --dev

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Wait for LocalStack
        run: |
          for i in {1..30}; do
            if curl -s http://localhost:4566/_localstack/health | grep -q '"ec2"'; then
              echo "LocalStack is ready"
              break
            fi
            echo "Waiting for LocalStack... ($i/30)"
            sleep 2
          done

      - name: Setup LocalStack resources
        env:
          AWS_ACCESS_KEY_ID: test
          AWS_SECRET_ACCESS_KEY: test
          AWS_DEFAULT_REGION: us-east-1
        run: |
          pip install awscli-local
          bash localstack-init/01-setup-vpc.sh

      - name: Run Integration Tests
        env:
          AWS_ACCESS_KEY_ID: test
          AWS_SECRET_ACCESS_KEY: test
          AWS_DEFAULT_REGION: us-east-1
          STORAGE_EMULATOR_HOST: http://localhost:4443
        run: |
          uv run pytest tests/integration/ \
            --json-report \
            --json-report-file=integration-results.json \
            -v

      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: integration-test-results
          path: integration-results.json

  # ==========================================================================
  # Stage 6: Inference Tests (Docker)
  # ==========================================================================
  inference-tests:
    name: Inference Tests
    runs-on: ubuntu-latest
    needs: terraform-validate
    if: ${{ !contains(github.event.head_commit.message, '[skip-inference]') }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Install dependencies
        run: uv sync --dev

      - name: Check if test compose exists
        id: check-compose
        run: |
          if [ -f docker-compose.test.yml ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Start test stack
        if: steps.check-compose.outputs.exists == 'true'
        run: docker compose -f docker-compose.test.yml up -d
        continue-on-error: true

      - name: Wait for healthy
        if: steps.check-compose.outputs.exists == 'true'
        run: |
          for i in {1..60}; do
            if curl -s http://localhost:8080/health 2>/dev/null | grep -q "healthy"; then
              echo "Inference server is ready"
              exit 0
            fi
            echo "Waiting for inference server... ($i/60)"
            sleep 2
          done
          echo "Warning: Inference server not ready, running available tests"
        continue-on-error: true

      - name: Run smoke tests
        run: |
          uv run pytest tests/test_smoke.py \
            -m smoke \
            --json-report \
            --json-report-file=smoke-results.json \
            -v || true

      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: inference-test-results
          path: |
            smoke-results.json

      - name: Cleanup
        if: always() && steps.check-compose.outputs.exists == 'true'
        run: docker compose -f docker-compose.test.yml down -v || true

  # ==========================================================================
  # Summary
  # ==========================================================================
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [static-analysis, security-scan, terraform-tests, integration-tests]
    if: always()
    steps:
      - name: Check job statuses
        run: |
          echo "Static Analysis: ${{ needs.static-analysis.result }}"
          echo "Security Scan: ${{ needs.security-scan.result }}"
          echo "Terraform Tests: ${{ needs.terraform-tests.result }}"
          echo "Integration Tests: ${{ needs.integration-tests.result }}"

          if [[ "${{ needs.static-analysis.result }}" == "failure" ]] || \
             [[ "${{ needs.security-scan.result }}" == "failure" ]] || \
             [[ "${{ needs.terraform-tests.result }}" == "failure" ]] || \
             [[ "${{ needs.integration-tests.result }}" == "failure" ]]; then
            echo "One or more tests failed!"
            exit 1
          fi

          echo "All tests passed!"
