# SkyPilot configuration for Pure Rust BitNet Testing on ARM
# Tests the pure Rust inference engine with ARM NEON on GCP Tau T2A
#
# Instance: GCP t2a-standard-8 (Ampere Altra, 8 vCPUs, 32 GB RAM)
# Cost: ~$0.28/hour
#
# Launch:
#   sky launch skypilot/benchmark/arm_rust_test.yaml -c arm-rust -y
#
# Run tests:
#   sky exec arm-rust --workdir . -- cargo test -p sgl-model-gateway --features native-inference
#
# Monitor:
#   sky logs arm-rust --follow

name: arm-rust-test

resources:
  cloud: gcp
  instance_type: t2a-standard-8  # Ampere Altra ARM64
  region: us-central1
  disk_size: 100
  use_spot: false
  image_id: projects/ubuntu-os-accelerator-images/global/images/ubuntu-accelerator-2204-arm64-with-nvidia-580-v20260108

envs:
  RAYON_NUM_THREADS: "8"
  RUST_BACKTRACE: "1"

file_mounts:
  /opt/inference: .

setup: |
  set -ex
  echo "============================================"
  echo "Pure Rust BitNet ARM Test Setup"
  echo "Instance: GCP t2a-standard-8 (Ampere Altra)"
  echo "Architecture: $(uname -m)"
  echo "============================================"

  # Verify we're on ARM
  if [ "$(uname -m)" != "aarch64" ]; then
    echo "ERROR: This is not an ARM64 instance!"
    exit 1
  fi

  # System dependencies
  sudo apt-get update && sudo apt-get install -y \
    build-essential pkg-config libssl-dev curl git protobuf-compiler

  # Install Rust
  if ! command -v cargo &> /dev/null; then
    curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
    source "$HOME/.cargo/env"
  fi

  # Verify Rust target
  rustup show
  echo "Rust target: $(rustc -vV | grep host)"

  echo "=== Setup Complete ==="

run: |
  set -ex
  source "$HOME/.cargo/env"

  # Use sky_workdir for latest code changes
  WORKDIR="$HOME/sky_workdir/extern/sglang-bitnet/sgl-model-gateway"

  if [ -d "$WORKDIR" ]; then
    cd "$WORKDIR"
  else
    cd /opt/inference/extern/sglang-bitnet/sgl-model-gateway
  fi

  echo "============================================"
  echo "Pure Rust BitNet ARM Test"
  echo "Architecture: $(uname -m)"
  echo "Rust target: $(rustc -vV | grep host)"
  echo "Working directory: $(pwd)"
  echo "============================================"

  # Step 1: Run unit tests
  echo ""
  echo "=== Step 1: Running Unit Tests ==="
  cargo test -p sgl-model-gateway --lib -- --nocapture 2>&1 | head -200

  # Step 2: Test bitnet kernel module specifically
  echo ""
  echo "=== Step 2: BitNet Kernel Tests ==="
  cargo test -p sgl-model-gateway kernels::bitnet -- --nocapture

  # Step 3: Check CPU capabilities
  echo ""
  echo "=== Step 3: CPU Capabilities ==="
  cargo run --release --example cpu_caps 2>/dev/null || echo "No cpu_caps example, skipping"

  # Step 4: Build wf_server (without C++ deps)
  echo ""
  echo "=== Step 4: Building wf_server (pure Rust) ==="
  # For now, just build the library to verify compilation
  cargo build --release --lib 2>&1 | tail -20

  echo ""
  echo "============================================"
  echo "TEST COMPLETE"
  echo "============================================"
  echo ""
  echo "CPU: $(lscpu | grep 'Model name' | cut -d: -f2 | xargs)"
  echo "Architecture: $(uname -m)"
  echo ""
  echo "All unit tests should have passed above."
  echo "Next: Enable full wf_server build after updating engine/model.rs"
