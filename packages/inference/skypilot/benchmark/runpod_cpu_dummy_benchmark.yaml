# SkyPilot configuration for RunPod CPU benchmarking with Randomly Initialized Models
# Generates a dummy model on the fly to avoid download times and test large architectures
#
# Launch:
#   sky launch skypilot/benchmark/runpod_cpu_dummy_benchmark.yaml -c benchmark-cpu-dummy

name: bench-dummy

resources:
  cloud: runpod
  cpus: 8+
  memory: 32+
  disk_size: 100
  use_spot: false
  ports: 8080

envs:
  # Model config
  MODEL_SIZE: "bitnet_b1_58-3B"  # Options: bitnet_b1_58-3B, BitNet-b1.58-2B-4T, 70B, etc.
  QUANT_TYPE: i2_s
  
  # Server config
  NUM_THREADS: "8"
  CTX_SIZE: "4096"
  PORT: "8080"
  PARALLEL_SLOTS: "4"
  
  # Benchmark config
  BENCHMARK_MODE: "true"
  RESULTS_DIR: /results

workdir: ../..

setup: |
  set -ex

  # Install system dependencies
  apt-get update && apt-get install -y clang cmake git curl

  # Check CPU features
  echo "CPU Features:"
  lscpu | grep -E "(AVX|SSE)" || true

  # We use the synced workdir, so no need to clone.
  # SkyPilot syncs workdir to ~/sky_workdir
  cd ~/sky_workdir

  # Install Python dependencies
  pip install uv
  uv sync --extra benchmark

  # Setup BitNet
  cd extern/BitNet
  pip install -r requirements.txt

  # Set build flags for AVX512
  export LLAMA_AVX512=1
  export LLAMA_AVX512_VBMI=1

  # Generate dummy model and compile
  MODEL_DIR="models/$MODEL_SIZE"
  
  python setup_env.py \
    --dummy \
    --model-size $MODEL_SIZE \
    --model-dir $MODEL_DIR \
    --quant-type $QUANT_TYPE

  mkdir -p /results

run: |
  set -ex
  cd ~/sky_workdir/extern/BitNet

  MODEL_PATH="models/$MODEL_SIZE/ggml-model-$QUANT_TYPE.gguf"

  echo "=== BitNet CPU Dummy Benchmark ==="
  echo "Model: $MODEL_PATH"
  echo "Size: $MODEL_SIZE"
  echo "Context: $CTX_SIZE"
  echo "Threads: $NUM_THREADS"
  echo "Slots: $PARALLEL_SLOTS"

  # Start server in background
  ./build/bin/llama-server \
    -m "$MODEL_PATH" \
    -c $CTX_SIZE \
    -t $NUM_THREADS \
    -np $PARALLEL_SLOTS \
    --host 0.0.0.0 \
    --port $PORT &

  SERVER_PID=$!

  # Wait for server to be ready
  echo "Waiting for server to start..."
  for i in $(seq 1 60); do
    if curl -s http://localhost:$PORT/health > /dev/null 2>&1; then
      echo "Server is ready!"
      break
    fi
    sleep 2
  done

  # Run benchmark
  cd ~/sky_workdir
  # We use the 'bitnet-2b-4t' label for the reporter, but the actual model is the dummy one.
  # If we test larger models, we might want to update the benchmark script to accept custom model names
  # or just interpret the results knowing what we ran.
  
  python scripts/benchmark_cost.py \
    --url http://localhost:$PORT \
    --hardware cpu_64 \
    --model "dummy-$MODEL_SIZE" \
    --output-dir $RESULTS_DIR

  # Stop server
  kill $SERVER_PID 2>/dev/null || true

  echo "Benchmark complete. Results in $RESULTS_DIR"
