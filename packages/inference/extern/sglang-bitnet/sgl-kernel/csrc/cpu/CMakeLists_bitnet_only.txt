# CMakeLists for BitNet-only build
#
# This builds only the BitNet SIMD kernels without the general-purpose CPU ops
# that use incompatible PyTorch internal APIs (brgemm, exp_u20).
#
# Usage:
#   cp CMakeLists_bitnet_only.txt CMakeLists.txt
#   pip install -e . --no-build-isolation

cmake_minimum_required(VERSION 3.18 FATAL_ERROR)
project(sgl_kernel)

set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_CXX_EXTENSIONS OFF)

find_package(Python COMPONENTS Interpreter Development.Module ${SKBUILD_SABI_COMPONENT} REQUIRED)

execute_process(
    COMMAND ${Python_EXECUTABLE}
            -c "import torch; print(torch.utils.cmake_prefix_path)"
    OUTPUT_VARIABLE TORCH_PY_PREFIX
    OUTPUT_STRIP_TRAILING_WHITESPACE
)

message(STATUS "PyTorch prefix: ${TORCH_PY_PREFIX}")
list(APPEND CMAKE_PREFIX_PATH ${TORCH_PY_PREFIX}/Torch)

# Disable CUDA for CPU-only build
set(USE_CUDA OFF CACHE BOOL "" FORCE)
set(CAFFE2_USE_CUDNN OFF CACHE BOOL "" FORCE)
set(CAFFE2_USE_CUDA OFF CACHE BOOL "" FORCE)
find_package(Torch REQUIRED)

include_directories(
    ${TORCH_INCLUDE_DIRS}
    ${TORCH_INSTALL_PREFIX}/include
    ${Python_INCLUDE_DIRS}
    ${CMAKE_CURRENT_SOURCE_DIR}/../../csrc
    ${CMAKE_CURRENT_SOURCE_DIR}/../../include
    ${CMAKE_CURRENT_SOURCE_DIR}
    ${CMAKE_CURRENT_SOURCE_DIR}/../bitnet
)

# Platform-specific library directory
if(CMAKE_SYSTEM_PROCESSOR MATCHES "x86_64|AMD64")
    set(PLAT_LIB_DIR "/usr/lib/x86_64-linux-gnu")
elseif(CMAKE_SYSTEM_PROCESSOR MATCHES "aarch64|arm64")
    set(PLAT_LIB_DIR "/usr/lib/aarch64-linux-gnu")
else()
    set(PLAT_LIB_DIR "/usr/lib/${CMAKE_SYSTEM_PROCESSOR}-linux-gnu")
endif()
link_directories(${PLAT_LIB_DIR})

# ============================================================================
# BitNet-only sources - no brgemm/exp_u20 dependencies
# ============================================================================
set(BITNET_SOURCES
    ${CMAKE_CURRENT_SOURCE_DIR}/torch_extension_bitnet_only.cpp
    ${CMAKE_CURRENT_SOURCE_DIR}/bitnet_fused_layer.cpp
    ${CMAKE_CURRENT_SOURCE_DIR}/../bitnet/bitnet_gemv.cpp
)

message(STATUS "Building BitNet-only sgl-kernel (no brgemm/exp_u20)")
message(STATUS "Sources: ${BITNET_SOURCES}")

# Compiler flags for maximum performance
add_compile_options(
    -O3
    -Wno-unknown-pragmas
    -march=native
    -fopenmp
    # Aggressive optimizations
    -ffast-math
    -funroll-loops
    -ftree-vectorize
    -fno-semantic-interposition
)

# Enable AVX-512 if available (AMD EPYC Genoa, Intel Sapphire Rapids)
if(CMAKE_SYSTEM_PROCESSOR MATCHES "x86_64|AMD64")
    add_compile_options(
        -mavx2
        -mfma
    )
    # Check for AVX-512 at runtime, enable compile-time support
    include(CheckCXXCompilerFlag)
    check_cxx_compiler_flag("-mavx512f" HAS_AVX512F)
    if(HAS_AVX512F)
        add_compile_options(
            -mavx512f -mavx512bw -mavx512dq -mavx512vl
        )
        message(STATUS "AVX-512 enabled")
    endif()
endif()

# Enable Link-Time Optimization
set(CMAKE_INTERPROCEDURAL_OPTIMIZATION ON)

# Build the extension
Python_add_library(common_ops MODULE USE_SABI ${SKBUILD_SABI_VERSION} WITH_SOABI ${BITNET_SOURCES})
target_link_libraries(common_ops PRIVATE ${TORCH_LIBRARIES})
target_include_directories(common_ops PRIVATE ${TORCH_INCLUDE_DIRS})

install(TARGETS common_ops
    LIBRARY DESTINATION sgl_kernel
)
